<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FPAS Login</title>
  <link rel="stylesheet" href="style.css">
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#38bdf8">
</head>
<body class="center">

<div class="login-card glass">
  <h2>FPAS Login</h2>

  <select id="role">
    <option value="admin">Admin</option>
    <option value="faculty">Faculty</option>
  </select>

  <input id="userid" placeholder="User ID">
  
  <div class="pass-box">
    <input id="password" type="password" placeholder="Password">
    <span onclick="togglePass()">üëÅ</span>
  </div>

  <div class="captcha">
    <span id="capText"></span>
    <input id="captcha" placeholder="Answer">
    <button type="button" onclick="generateCaptcha()">üîÑ</button>
  </div>

  <button onclick="login()">Login</button>
</div>

<script src="dashboard.js"></script>
<script>
/* ---------- USERS ---------- */
let users = JSON.parse(localStorage.getItem("users")) || {
  A001:{role:"admin",pass:"admin123"},
  A002:{role:"admin",pass:"admin123"},
  A003:{role:"admin",pass:"admin123"},
  F001:{role:"faculty",pass:"faculty123"},
  F002:{role:"faculty",pass:"faculty123"},
  F003:{role:"faculty",pass:"faculty123"},
  F004:{role:"faculty",pass:"faculty123"},
  F005:{role:"faculty",pass:"faculty123"},
  F006:{role:"faculty",pass:"faculty123"},
  F007:{role:"faculty",pass:"faculty123"}
};
localStorage.setItem("users", JSON.stringify(users));

/* ---------- CAPTCHA ---------- */
let a, b, op, captchaAnswer;

function generateCaptcha(){
  a = Math.floor(Math.random()*10) + 1; // 1-10
  b = Math.floor(Math.random()*10) + 1; // 1-10
  const operators = ['+', '-', '*'];
  op = operators[Math.floor(Math.random()*3)];

  // Adjust subtraction to avoid negative answers
  if(op === '-') {
    if(a < b){ [a, b] = [b, a]; } // swap so a >= b
    captchaAnswer = a - b;
  } else if(op === '+') {
    captchaAnswer = a + b;
  } else { // multiplication
    captchaAnswer = a * b;
  }

  document.getElementById("capText").innerText = `${a} ${op} ${b} = ?`;
}

/* Generate captcha after DOM is ready */
window.addEventListener("DOMContentLoaded", generateCaptcha);

/* ---------- PASSWORD TOGGLE ---------- */
function togglePass(){
  const p = document.getElementById("password");
  p.type = p.type==="password"?"text":"password";
}

/* ---------- LOGIN ---------- */
function login(){
  const id = document.getElementById("userid").value;
  const pass = document.getElementById("password").value;
  const role = document.getElementById("role").value;
  const cap = parseInt(document.getElementById("captcha").value);

  if(cap !== captchaAnswer) {
    alert("Captcha incorrect");
    generateCaptcha(); // regenerate if wrong
    return;
  }

  const user = JSON.parse(localStorage.getItem("users"))[id];
  if(user && user.pass === pass && user.role === role){
    localStorage.setItem("user",id);
    localStorage.setItem("role",role);
    location.href = "dashboard.html";
  } else {
    alert("Invalid credentials");
    generateCaptcha(); // regenerate if login fails
  }
}

/* ---------- SERVICE WORKER ---------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(reg => console.log("Service Worker Registered", reg))
    .catch(err => console.log("SW Registration Failed", err));
}
</script>
</body>
</html>
